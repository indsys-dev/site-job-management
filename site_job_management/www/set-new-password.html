<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Set New Password</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 20px rgba(0,0,0,0.1); width: 100%; max-width: 420px; }
        h2 { color: #333; margin-bottom: 8px; }
        .subtitle { color: #666; margin-bottom: 28px; font-size: 14px; }
        label { display: block; color: #555; font-size: 14px; margin-bottom: 6px; font-weight: 600; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; margin-bottom: 18px; }
        input:focus { outline: none; border-color: #2196F3; box-shadow: 0 0 0 2px rgba(33,150,243,0.2); }
        button { width: 100%; padding: 14px; background: #2196F3; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: 600; }
        button:hover { background: #1976D2; }
        button:disabled { background: #90CAF9; cursor: not-allowed; }
        .msg { padding: 12px; border-radius: 6px; margin-bottom: 18px; font-size: 14px; display: none; }
        .msg.error { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }
        .msg.success { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
        .rules { font-size: 12px; color: #888; margin-top: -12px; margin-bottom: 18px; }
    </style>
</head>
<body>
<div class="card">
    <h2>ðŸ”‘ Set New Password</h2>
    <p class="subtitle" id="greeting">Please set a new password for your account.</p>

    <div class="msg error" id="error-msg"></div>
    <div class="msg success" id="success-msg"></div>

    <div id="password-form">
        <label for="new-password">New Password</label>
        <input type="password" id="new-password" placeholder="Enter new password" />
        <div class="rules">Min 8 chars Â· Uppercase Â· Lowercase Â· Number Â· Special char</div>

        <label for="confirm-password">Confirm Password</label>
        <input type="password" id="confirm-password" placeholder="Re-enter new password" />

        <button type="button" id="submit-btn" onclick="handleSubmit()">Set Password & Login</button>
    </div>
</div>

<script>
    var params = new URLSearchParams(window.location.search);
    var token = params.get("token");
    var cached_username = "";  // âœ… stores username from token

    function getCsrfToken() {
        var cookies = document.cookie.split("; ");
        for (var i = 0; i < cookies.length; i++) {
            var parts = cookies[i].split("=");
            if (parts[0] === "csrf_token") {
                return decodeURIComponent(parts[1]);
            }
        }
        return "Guest";
    }

    function showError(msg) {
        var el = document.getElementById("error-msg");
        el.textContent = msg;
        el.style.display = "block";
        document.getElementById("success-msg").style.display = "none";
    }

    function showSuccess(msg) {
        var el = document.getElementById("success-msg");
        el.textContent = msg;
        el.style.display = "block";
        document.getElementById("error-msg").style.display = "none";
    }

    if (!token) {
        showError("Invalid link. No token found. Please try logging in again.");
        document.getElementById("password-form").style.display = "none";
    } else {
        fetch("/api/method/site_job_management.api.validate_password_token?token=" + encodeURIComponent(token))
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.message && data.message.status === "valid") {
                    cached_username = data.message.username || "";  // âœ… store username
                    document.getElementById("greeting").textContent =
                        "Hello " + data.message.full_name + ", please set your new password.";
                } else {
                    showError("This link is invalid or has expired. Please login again.");
                    document.getElementById("password-form").style.display = "none";
                }
            })
            .catch(function() {
                showError("Could not validate the link. Please try again.");
                document.getElementById("password-form").style.display = "none";
            });
    }

    function handleSubmit() {
        var newPassword = document.getElementById("new-password").value;
        var confirmPassword = document.getElementById("confirm-password").value;
        var btn = document.getElementById("submit-btn");

        if (!newPassword || !confirmPassword) {
            showError("Please fill in both password fields.");
            return;
        }

        if (newPassword !== confirmPassword) {
            showError("Passwords do not match!");
            return;
        }

        btn.disabled = true;
        btn.textContent = "Setting password...";

        fetch("/api/method/frappe.auth.get_logged_user")
            .then(function(res) { return res.json(); })
            .then(function(userData) {
                var loggedUser = userData.message;

                // âœ… Already logged in as a different user
                if (loggedUser && loggedUser !== "Guest" && loggedUser !== cached_username) {
                    showError("You are already logged in as " + loggedUser + ". Please logout first and try again.");
                    btn.disabled = false;
                    btn.textContent = "Set Password & Login";
                    return Promise.reject("already_logged_in");
                }

                var csrfToken = getCsrfToken();
                var formData = new URLSearchParams();
                formData.append("token", token);
                formData.append("new_password", newPassword);
                formData.append("confirm_password", confirmPassword);

                return fetch("/api/method/site_job_management.api.set_new_password_via_token", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-Frappe-CSRF-Token": csrfToken
                    },
                    body: formData.toString()
                });
            })
            .then(function(res) {
                if (!res) return;
                return res.json();
            })
            .then(function(data) {
                if (!data) return;
                console.log("Server response:", JSON.stringify(data));
                if (data.message && data.message.status === "success") {
                    showSuccess("âœ… Password set! Redirecting to your dashboard...");
                    setTimeout(function() {
                        window.location.href = "/app";
                    }, 2000);
                } else {
                    var errMsg = "Something went wrong.";
                    try {
                        var msgs = JSON.parse(data._server_messages || "[]");
                        errMsg = JSON.parse(msgs[0]).message || errMsg;
                    } catch(e) {}
                    showError(errMsg);
                    btn.disabled = false;
                    btn.textContent = "Set Password & Login";
                }
            })
            .catch(function(err) {
                if (err === "already_logged_in") return;
                console.log("Fetch error:", err);
                showError("Network error. Please try again.");
                btn.disabled = false;
                btn.textContent = "Set Password & Login";
            });
    }
</script>
</body>
</html>